<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª ××˜×‘×—</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background: #f3f4f6;
      direction: rtl;
      font-size: 14px;
      line-height: 1.4;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .title {
      font-size: 24px;
      font-weight: bold;
      color: #1f2937;
    }

    .subtitle {
      font-size: 12px;
      color: #6b7280;
      margin-top: 5px;
    }

    .buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: all 0.2s;
    }

    .btn-primary { background: #3b82f6; color: white; }
    .btn-primary:hover { background: #2563eb; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-gray { background: #6b7280; color: white; }
    .btn-gray:hover { background: #4b5563; }

    .section {
      margin-bottom: 30px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .grid {
      display: grid;
      gap: 15px;
    }

    .grid-2 { grid-template-columns: 1fr 1fr; }
    .grid-3 { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
    .grid-4 { grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); }

    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
      .header { flex-direction: column; align-items: stretch; }
      .buttons { justify-content: center; }
      .title { font-size: 20px; text-align: center; }
    }

    .worker-card {
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
    }

    .worker-card.cook { border-color: #3b82f6; background: #eff6ff; }
    .worker-card.responsible { border-color: #8b5cf6; background: #f3e8ff; }

    .worker-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 10px;
    }

    .worker-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: white;
      border-radius: 4px;
      margin-bottom: 5px;
      border: 1px solid #e5e7eb;
    }

    .worker-item:last-child { margin-bottom: 0; }

    .remove-btn {
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
    }

    .stat-card {
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      border: 2px solid;
      font-size: 12px;
    }

    .stat-green { background: #dcfce7; border-color: #16a34a; color: #166534; }
    .stat-yellow { background: #fef3c7; border-color: #d97706; color: #92400e; }
    .stat-orange { background: #fed7aa; border-color: #ea580c; color: #9a3412; }
    .stat-red { background: #fecaca; border-color: #dc2626; color: #991b1b; }
    .stat-blue { background: #dbeafe; border-color: #2563eb; color: #1e40af; }

    .target-input {
      background: #f9fafb;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 15px;
      max-width: 300px;
      margin: 0 auto;
    }

    .target-input input {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
    }

    .table-container {
      overflow-x: auto;
      border: 2px solid #d1d5db;
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border: 1px solid #d1d5db;
      padding: 8px;
      text-align: center;
    }

    th {
      background: #f3f4f6;
      font-weight: 600;
      font-size: 11px;
    }

    .shift-cell {
      min-width: 120px;
      padding: 5px;
    }

    .worker-tag {
      display: inline-block;
      background: #3b82f6;
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      margin: 1px;
      font-size: 10px;
    }

    .worker-tag.responsible { background: #8b5cf6; }
    .worker-tag.cooking { background: #f59e0b; }
    .worker-tag.salads { background: #10b981; }

    .add-btn {
      background: #10b981;
      color: white;
      border: 1px dashed #16a34a;
      border-radius: 4px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 10px;
      margin: 1px;
      display: inline-block;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .modal.show { display: flex; align-items: center; justify-content: center; padding: 20px; }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      max-width: 400px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      font-size: 16px;
      font-weight: 600;
      text-align: center;
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
    }

    .modal-buttons {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .worker-select {
      max-height: 250px;
      overflow-y: auto;
    }

    .worker-option {
      width: 100%;
      padding: 10px;
      margin-bottom: 5px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      background: white;
      cursor: pointer;
      text-align: right;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .worker-option:hover { background: #f9fafb; }

    .na-cell {
      background: #f3f4f6;
      color: #6b7280;
      font-style: italic;
    }

    .day-cell {
      background: #f8fafc;
      font-weight: 600;
      writing-mode: horizontal-tb;
    }

    .shift-weekend {
      color: #dc2626;
      font-weight: 600;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="card">
    <div class="header">
      <div>
        <div class="title">ğŸ“… ××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª ××˜×‘×—</div>
        <div class="subtitle">ğŸ’¾ ×”× ×ª×•× ×™× × ×©××¨×™× ××•×˜×•××˜×™×ª ×‘×“×¤×“×¤×Ÿ</div>
      </div>
      <div class="buttons">
        <div class="buttons">
          <button class="btn btn-warning" onclick="clearAllData()">ğŸ—‘ï¸ × ×§×”</button>
          <button class="btn btn-danger" onclick="showResetModal()">âš ï¸ ××™×¤×•×¡</button>
          <button class="btn btn-primary" onclick="exportData()">ğŸ“¥ ×™×™×¦×•×</button>
          <button class="btn btn-blue" onclick="saveToFirebase()">ğŸ’¾ ×©××•×¨ ×©×‘×•×¢</button>
          <button class="btn btn-gray" onclick="loadHistory()">ğŸ“Š ×˜×¢×Ÿ ×”×™×¡×˜×•×¨×™×”</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Workers Management -->
  <div class="card">
    <div class="section">
      <div class="section-title">
        ğŸ‘¥ × ×™×”×•×œ ×¢×•×‘×“×™×
        <button class="btn btn-success" onclick="showAddWorkerModal()">â• ×”×•×¡×£ ×¢×•×‘×“</button>
      </div>
      <div class="grid grid-2">
        <div class="worker-card cook">
          <h3>ğŸ³ ×˜×‘×—×™× (<span id="cooksCount">0</span>)</h3>
          <div id="cooksList" class="worker-list"></div>
        </div>
        <div class="worker-card responsible">
          <h3>ğŸ‘¨â€ğŸ’¼ ××—×¨××™ ×ª×•×¨× ×™× (<span id="responsibleCount">0</span>)</h3>
          <div id="responsibleList" class="worker-list"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Target Shifts -->
  <div class="card">
    <div class="section">
      <div class="section-title">ğŸ¯ ×”×’×“×¨×ª ×™×¢×“ ××©××¨×•×ª</div>
      <div class="target-input">
        <label>××¡×¤×¨ ××©××¨×•×ª ×œ×›×œ ×¢×•×‘×“ ×‘×©×‘×•×¢:</label>
        <input type="number" id="targetShifts" min="0" max="8" value="4">
      </div>
    </div>
  </div>

  <!-- Worker Stats -->
  <div class="card">
    <div class="section">
      <div class="section-title">ğŸ“Š ××¢×§×‘ ××©××¨×•×ª ×¢×•×‘×“×™×</div>
      <div id="workerStats" class="stats-grid"></div>
    </div>
  </div>

  <!-- Schedule Table -->
  <div class="card">
    <div class="section">
      <div class="section-title">ğŸ“‹ ×œ×•×— ×–×× ×™×</div>
      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>×™×•×</th>
            <th>××©××¨×ª</th>
            <th>×˜×‘×—×™×</th>
            <th>××—×´×ª</th>
            <th>××—×¨××™ ×‘×™×©×•×œ×™×</th>
            <th>××—×¨××™ ×¡×œ×˜×™×</th>
          </tr>
          </thead>
          <tbody id="scheduleTable"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<div id="addWorkerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">×”×•×¡×£ ×¢×•×‘×“ ×—×“×©</div>
    <div class="form-group">
      <label>×©× ×”×¢×•×‘×“:</label>
      <input type="text" id="newWorkerName" placeholder="×”×–×Ÿ ×©× ×¢×•×‘×“">
    </div>
    <div class="form-group">
      <label>×¡×•×’ ×¢×•×‘×“:</label>
      <select id="newWorkerType">
        <option value="cook">×˜×‘×—</option>
        <option value="responsible">××—×¨××™ ×ª×•×¨×Ÿ</option>
      </select>
    </div>
    <div class="modal-buttons">
      <button class="btn btn-success" onclick="addNewWorker()" style="flex: 1">×”×•×¡×£</button>
      <button class="btn btn-gray" onclick="hideAddWorkerModal()" style="flex: 1">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div id="selectWorkerModal" class="modal">
  <div class="modal-content">
    <div id="selectWorkerTitle" class="modal-header"></div>
    <div id="workerSelectionList" class="worker-select"></div>
    <div class="modal-buttons">
      <button class="btn btn-gray" onclick="hideSelectWorkerModal()" style="width: 100%">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div id="resetModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="color: #dc2626">âš ï¸ ××™×©×•×¨ ××™×¤×•×¡</div>
    <p style="text-align: center; margin: 20px 0;">
      ×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ××¤×¡ ××ª ×›×œ ×”××©××¨×•×ª?<br>
      <strong style="color: #dc2626">×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.</strong>
    </p>
    <div class="modal-buttons">
      <button class="btn btn-danger" onclick="resetSystem()" style="flex: 1">×›×Ÿ, ××¤×¡ ×”×›×œ</button>
      <button class="btn btn-gray" onclick="hideResetModal()" style="flex: 1">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<div id="removeWorkerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header" style="color: #dc2626">âš ï¸ ××™×©×•×¨ ×”×¡×¨×ª ×¢×•×‘×“</div>
    <p id="removeWorkerText" style="text-align: center; margin: 20px 0;"></p>
    <div class="modal-buttons">
      <button class="btn btn-blue" onclick="saveToFirebase()">ğŸ’¾ ×©××•×¨ ×©×‘×•×¢</button>
      <button class="btn btn-gray" onclick="loadHistory()">ğŸ“Š ×˜×¢×Ÿ ×”×™×¡×˜×•×¨×™×”</button>
      <button class="btn btn-danger" onclick="confirmRemoveWorker()" style="flex: 1">×›×Ÿ, ×”×¡×¨ ×¢×•×‘×“</button>
      <button class="btn btn-gray" onclick="hideRemoveWorkerModal()" style="flex: 1">×‘×™×˜×•×œ</button>
    </div>
  </div>
</div>

<script>
  // Global variables
  let workers = {
    cooks: [
      { name: '××œ×™×”', restrictions: [] },
      { name: '××œ×™××‘', restrictions: ['onlyMorning', 'onlySunToWed', 'noCooking'] },
      { name: '×™×”×•×“×”', restrictions: ['noCooking', 'saladsOnly'] },
      { name: '××¤×¨×™×', restrictions: [] },
      { name: '×œ×™××•×¨', restrictions: [] },
      { name: '××™×ª×™', restrictions: ['prefersSalads'] },
      { name: '×™×¦×—×§', restrictions: [] },
      { name: '×™×•×¡×£', restrictions: [] }
    ],
    responsible: ['××œ×™', '××•×¨×™××œ', '××¨×™××œ']
  };

  const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×¡×•×¤×©'];
  let schedule = {};
  let targetShifts = 4;
  let selectedCell = null;
  let workerToRemove = null;

  // Storage functions
  function saveToStorage() {
    const data = { workers, schedule, targetShifts };
    localStorage.setItem('kitchenShifts', JSON.stringify(data));
  }

  function loadFromStorage() {
    try {
      const saved = localStorage.getItem('kitchenShifts');
      if (saved) {
        const data = JSON.parse(saved);
        workers = data.workers || workers;
        schedule = data.schedule || {};
        targetShifts = data.targetShifts || 4;
        document.getElementById('targetShifts').value = targetShifts;
        return true;
      }
    } catch (error) {
      console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×:', error);
    }
    return false;
  }

  function clearStorage() {
    localStorage.removeItem('kitchenShifts');
  }

  // Initialize schedule
  function initializeSchedule() {
    schedule = {};
    days.forEach(day => {
      schedule[day] = {};
      if (day === '×¡×•×¤×©') {
        schedule[day]['×›×œ ×”×¡×•×¤×©'] = {
          cooks: [], responsible: [], cookingChef: '', saladsChef: ''
        };
      } else {
        const shiftsForDay = day === '×©×™×©×™' ? ['×‘×•×§×¨'] : ['×‘×•×§×¨', '×¢×¨×‘'];
        shiftsForDay.forEach(shift => {
          schedule[day][shift] = {
            cooks: [], responsible: [], cookingChef: '', saladsChef: ''
          };
        });
      }
    });
  }

  // Worker shift count calculation
  function getWorkerShiftCount(workerName) {
    let count = 0;
    days.forEach(day => {
      if (day === '×¡×•×¤×©') {
        const shiftData = schedule[day]['×›×œ ×”×¡×•×¤×©'];
        if (shiftData.cooks.includes(workerName)) count += 2;
        if (shiftData.responsible.includes(workerName)) count += 2;
      } else {
        const shiftsForDay = day === '×©×™×©×™' ? ['×‘×•×§×¨'] : ['×‘×•×§×¨', '×¢×¨×‘'];
        shiftsForDay.forEach(shift => {
          const shiftData = schedule[day][shift];
          if (shiftData.cooks.includes(workerName)) count += 1;
          if (shiftData.responsible.includes(workerName)) count += 1;
          if (shiftData.cookingChef === workerName && !shiftData.cooks.includes(workerName)) count += 1;
          if (shiftData.saladsChef === workerName && !shiftData.cooks.includes(workerName)) count += 1;
        });
      }
    });
    return count;
  }

  // Check if worker can work
  function canWorkerWork(workerName, day, shift, role) {
    const worker = workers.cooks.find(c => c.name === workerName);
    const canBeResponsible = ['××™×ª×™', '×™×”×•×“×”', '×œ×™××•×¨', '××¤×¨×™×'].includes(workerName);
    const isFullTimeResponsible = workers.responsible.includes(workerName);

    if (isFullTimeResponsible && role !== 'responsible') return false;
    if (!worker && !isFullTimeResponsible && !canBeResponsible) return false;

    if (day === '×¡×•×¤×©') {
      if (isFullTimeResponsible && role !== 'responsible') return false;
      return true;
    }

    if (workerName === '××œ×™××‘' && worker) {
      if (shift === '×¢×¨×‘') return false;
      if (!['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™'].includes(day)) return false;
      if (role === 'salads') return false;
    }

    if (workerName === '×™×”×•×“×”' && worker && role === 'cooking') return false;

    return true;
  }

  // Get available workers
  function getAvailableWorkers(day, shift, role) {
    let available = [];
    const shiftValue = day === '×¡×•×¤×©' ? 2 : 1;

    if (role === 'responsible') {
      available = workers.responsible.filter(worker => {
        const currentCount = getWorkerShiftCount(worker);
        return canWorkerWork(worker, day, shift, role) && (currentCount + shiftValue) <= targetShifts;
      });

      const cookResponsibles = ['××™×ª×™', '×™×”×•×“×”', '×œ×™××•×¨', '××¤×¨×™×'].filter(worker => {
        const currentCount = getWorkerShiftCount(worker);
        return workers.cooks.some(cook => cook.name === worker) &&
                canWorkerWork(worker, day, shift, role) &&
                (currentCount + shiftValue) <= targetShifts;
      });

      available = [...available, ...cookResponsibles];
    } else {
      available = workers.cooks
              .map(cook => cook.name)
              .filter(worker => {
                const currentCount = getWorkerShiftCount(worker);
                return canWorkerWork(worker, day, shift, role) && (currentCount + shiftValue) <= targetShifts;
              });
    }

    return available;
  }

  // Get worker color based on shift count
  function getWorkerColor(current, target) {
    const ratio = current / target;
    if (current === 0) return 'stat-green';
    if (ratio <= 0.5) return 'stat-yellow';
    if (ratio <= 0.75) return 'stat-orange';
    if (current >= target) return 'stat-red';
    return 'stat-blue';
  }

  // Add worker to shift
  function addWorkerToShift(day, shift, workerName, role) {
    const shiftData = schedule[day][shift];

    if (role === 'responsible') {
      if (!shiftData.responsible.includes(workerName)) {
        shiftData.responsible.push(workerName);
      }
    } else if (role === 'cooking') {
      shiftData.cookingChef = workerName;
    } else if (role === 'salads') {
      shiftData.saladsChef = workerName;
    } else {
      if (!shiftData.cooks.includes(workerName)) {
        shiftData.cooks.push(workerName);
      }
    }

    saveToStorage();
    renderSchedule();
    renderWorkerStats();
    hideSelectWorkerModal();
  }

  // Remove worker from shift
  function removeWorkerFromShift(day, shift, workerName, role) {
    const shiftData = schedule[day][shift];

    if (role === 'responsible') {
      shiftData.responsible = shiftData.responsible.filter(w => w !== workerName);
    } else if (role === 'cooking') {
      shiftData.cookingChef = '';
    } else if (role === 'salads') {
      shiftData.saladsChef = '';
    } else {
      shiftData.cooks = shiftData.cooks.filter(w => w !== workerName);
    }

    saveToStorage();
    renderSchedule();
    renderWorkerStats();
  }

  // Render workers list
  function renderWorkersList() {
    const cooksList = document.getElementById('cooksList');
    const responsibleList = document.getElementById('responsibleList');

    cooksList.innerHTML = '';
    responsibleList.innerHTML = '';

    workers.cooks.forEach(cook => {
      const div = document.createElement('div');
      div.className = 'worker-item';
      div.innerHTML = `
                    <span>${cook.name}</span>
                    <button class="remove-btn" onclick="showRemoveWorker('${cook.name}', 'cook')">Ã—</button>
                `;
      cooksList.appendChild(div);
    });

    workers.responsible.forEach(resp => {
      const div = document.createElement('div');
      div.className = 'worker-item';
      div.innerHTML = `
                    <span>${resp}</span>
                    <button class="remove-btn" onclick="showRemoveWorker('${resp}', 'responsible')">Ã—</button>
                `;
      responsibleList.appendChild(div);
    });

    document.getElementById('cooksCount').textContent = workers.cooks.length;
    document.getElementById('responsibleCount').textContent = workers.responsible.length;
  }

  // Render worker stats
  function renderWorkerStats() {
    const container = document.getElementById('workerStats');
    container.innerHTML = '';

    const allWorkers = [...workers.cooks.map(c => c.name), ...workers.responsible];

    allWorkers.forEach(worker => {
      const count = getWorkerShiftCount(worker);
      const div = document.createElement('div');
      div.className = `stat-card ${getWorkerColor(count, targetShifts)}`;
      div.innerHTML = `
                    <div style="font-weight: bold;">${worker}</div>
                    <div>${count}/${targetShifts}</div>
                `;
      container.appendChild(div);
    });
  }

  // Get shift requirements
  function getShiftRequirements(day, shift) {
    if (day === '×¡×•×¤×©') return { cooks: 0, responsible: 1, maxCooks: 6, maxResponsible: 2 };
    if (day === '×©×™×©×™' && shift === '×‘×•×§×¨') return { cooks: 1, responsible: 2, maxCooks: 6, maxResponsible: 2 };
    if (day === '×©×™×©×™' && shift === '×¢×¨×‘') return { cooks: 1, responsible: 1, maxCooks: 2, maxResponsible: 2 };
    if (day === '×—××™×©×™') return shift === '×‘×•×§×¨' ? { cooks: 3, responsible: 1, maxCooks: 6, maxResponsible: 2 } : { cooks: 1, responsible: 1, maxCooks: 2, maxResponsible: 2 };
    return shift === '×‘×•×§×¨' ? { cooks: 4, responsible: 1, maxCooks: 6, maxResponsible: 2 } : { cooks: 1, responsible: 1, maxCooks: 2, maxResponsible: 2 };
  }

  // Render schedule table
  function renderSchedule() {
    const tbody = document.getElementById('scheduleTable');
    tbody.innerHTML = '';

    days.forEach(day => {
      if (day === '×¡×•×¤×©') {
        const requirements = getShiftRequirements(day, '×›×œ ×”×¡×•×¤×©');
        const current = schedule[day]['×›×œ ×”×¡×•×¤×©'];

        const tr = document.createElement('tr');
        tr.innerHTML = `
                        <td class="day-cell">×¡×•×¤×©</td>
                        <td class="shift-weekend">×©×™×©×™ ×¢×¨×‘ + ×©×‘×ª (Ã—2)</td>
                        <td class="shift-cell">${renderShiftWorkers(day, '×›×œ ×”×¡×•×¤×©', 'cooks', current, requirements)}</td>
                        <td class="shift-cell">${renderShiftWorkers(day, '×›×œ ×”×¡×•×¤×©', 'responsible', current, requirements)}</td>
                        <td class="na-cell">×œ× ×¨×œ×•×•× ×˜×™</td>
                        <td class="na-cell">×œ× ×¨×œ×•×•× ×˜×™</td>
                    `;
        tbody.appendChild(tr);
      } else {
        const shiftsForDay = day === '×©×™×©×™' ? ['×‘×•×§×¨'] : ['×‘×•×§×¨', '×¢×¨×‘'];
        shiftsForDay.forEach((shift, index) => {
          const requirements = getShiftRequirements(day, shift);
          const current = schedule[day][shift];

          const tr = document.createElement('tr');

          let dayCell = '';
          if (index === 0) {
            dayCell = `<td class="day-cell" rowspan="${shiftsForDay.length}">${day}</td>`;
          }

          let shiftLabel = shift;
          if (day === '×©×™×©×™' && shift === '×‘×•×§×¨') {
            shiftLabel += ' (2 ××—×´×ª)';
          }

          tr.innerHTML = `
                            ${dayCell}
                            <td>${shiftLabel}</td>
                            <td class="shift-cell">${renderShiftWorkers(day, shift, 'cooks', current, requirements)}</td>
                            <td class="shift-cell">${renderShiftWorkers(day, shift, 'responsible', current, requirements)}</td>
                            <td class="shift-cell">${renderSpecialRole(day, shift, 'cooking', current)}</td>
                            <td class="shift-cell">${renderSpecialRole(day, shift, 'salads', current)}</td>
                        `;
          tbody.appendChild(tr);
        });
      }
    });
  }

  // Render shift workers
  function renderShiftWorkers(day, shift, type, current, requirements) {
    const workers = current[type] || [];
    const max = type === 'cooks' ? (shift === '×¢×¨×‘' ? 2 : 6) : 2;

    let html = '';

    workers.forEach(worker => {
      const tagClass = type === 'cooks' ? '' : 'responsible';
      html += `<span class="worker-tag ${tagClass}" onclick="removeWorkerFromShift('${day}', '${shift}', '${worker}', '${type}')" style="cursor: pointer;">${worker} Ã—</span>`;
    });

    if (workers.length < max) {
      const roleText = type === 'cooks' ? '×˜×‘×—' : '××—×´×ª';
      html += `<span class="add-btn" onclick="showWorkerSelection('${day}', '${shift}', '${type}')">+ ${roleText}</span>`;
    }

    html += `<div style="font-size: 9px; color: #666; margin-top: 2px;">${workers.length}/${requirements[type]} (××§×¡: ${max})</div>`;

    return html;
  }

  // Render special role
  function renderSpecialRole(day, shift, role, current) {
    const worker = current[role === 'cooking' ? 'cookingChef' : 'saladsChef'];
    const canAssign = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™'].includes(day) && shift === '×‘×•×§×¨';

    if (worker) {
      const tagClass = role === 'cooking' ? 'cooking' : 'salads';
      return `<span class="worker-tag ${tagClass}" onclick="removeWorkerFromShift('${day}', '${shift}', '${worker}', '${role}')" style="cursor: pointer;">${worker} Ã—</span>`;
    } else if (canAssign) {
      return `<span class="add-btn" onclick="showWorkerSelection('${day}', '${shift}', '${role}')">+ ×× ×”</span>`;
    }
    return '';
  }

  // Show worker selection modal
  function showWorkerSelection(day, shift, role) {
    selectedCell = { day, shift, role };
    const modal = document.getElementById('selectWorkerModal');
    const title = document.getElementById('selectWorkerTitle');
    const list = document.getElementById('workerSelectionList');

    const roleNames = {
      'cooks': '×˜×‘×—',
      'responsible': '××—×¨××™ ×ª×•×¨×Ÿ',
      'cooking': '××—×¨××™ ×‘×™×©×•×œ×™×',
      'salads': '××—×¨××™ ×¡×œ×˜×™×'
    };

    title.textContent = `×‘×—×¨ ${roleNames[role]} ×¢×‘×•×¨ ${day} - ${shift === '×›×œ ×”×¡×•×¤×©' ? '×¡×•×¤×©' : shift}`;

    list.innerHTML = '';
    const available = getAvailableWorkers(day, shift, role);

    if (available.length === 0) {
      list.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">××™×Ÿ ×¢×•×‘×“×™× ×–××™× ×™×</div>';
    } else {
      available.forEach(worker => {
        const count = getWorkerShiftCount(worker);
        const button = document.createElement('button');
        button.className = `worker-option ${getWorkerColor(count, targetShifts)}`;
        button.innerHTML = `
                        <span style="font-weight: bold;">${worker}</span>
                        <span style="font-size: 12px;">${count}/${targetShifts}</span>
                    `;
        button.onclick = () => addWorkerToShift(day, shift, worker, role);
        list.appendChild(button);
      });
    }

    modal.classList.add('show');
  }

  // Add new worker
  function addNewWorker() {
    const name = document.getElementById('newWorkerName').value.trim();
    const type = document.getElementById('newWorkerType').value;

    if (!name) {
      alert('× × ×œ×”×–×™×Ÿ ×©× ×¢×•×‘×“');
      return;
    }

    const allWorkers = [...workers.cooks.map(c => c.name), ...workers.responsible];
    if (allWorkers.includes(name)) {
      alert('×¢×•×‘×“ ×‘×©× ×–×” ×›×‘×¨ ×§×™×™×');
      return;
    }

    if (type === 'cook') {
      workers.cooks.push({ name, restrictions: [] });
    } else {
      workers.responsible.push(name);
    }

    document.getElementById('newWorkerName').value = '';
    hideAddWorkerModal();

    saveToStorage();
    renderWorkersList();
    renderWorkerStats();

    alert(`×¢×•×‘×“ "${name}" × ×•×¡×£ ×‘×”×¦×œ×—×”`);
  }

  // Show remove worker modal
  function showRemoveWorker(name, type) {
    workerToRemove = { name, type };
    const modal = document.getElementById('removeWorkerModal');
    const text = document.getElementById('removeWorkerText');

    text.innerHTML = `
                ×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ×”×¡×™×¨ ××ª <strong>${name}</strong>?<br>
                <span style="color: #dc2626;">×¤×¢×•×œ×” ×–×• ×ª××—×§ ××•×ª×• ××›×œ ×”××©××¨×•×ª.</span>
            `;

    modal.classList.add('show');
  }

  // Confirm remove worker
  function confirmRemoveWorker() {
    const { name, type } = workerToRemove;

    // Remove from shifts
    days.forEach(day => {
      if (day === '×¡×•×¤×©') {
        const shift = schedule[day]['×›×œ ×”×¡×•×¤×©'];
        shift.cooks = shift.cooks.filter(c => c !== name);
        shift.responsible = shift.responsible.filter(r => r !== name);
        if (shift.cookingChef === name) shift.cookingChef = '';
        if (shift.saladsChef === name) shift.saladsChef = '';
      } else {
        const shiftsForDay = day === '×©×™×©×™' ? ['×‘×•×§×¨'] : ['×‘×•×§×¨', '×¢×¨×‘'];
        shiftsForDay.forEach(shiftName => {
          const shift = schedule[day][shiftName];
          shift.cooks = shift.cooks.filter(c => c !== name);
          shift.responsible = shift.responsible.filter(r => r !== name);
          if (shift.cookingChef === name) shift.cookingChef = '';
          if (shift.saladsChef === name) shift.saladsChef = '';
        });
      }
    });

    // Remove from workers list
    if (type === 'cook') {
      workers.cooks = workers.cooks.filter(c => c.name !== name);
    } else {
      workers.responsible = workers.responsible.filter(r => r !== name);
    }

    hideRemoveWorkerModal();

    saveToStorage();
    renderWorkersList();
    renderWorkerStats();
    renderSchedule();

    alert(`×¢×•×‘×“ "${name}" ×”×•×¡×¨ ×‘×”×¦×œ×—×”`);
  }

  // Reset system
  function resetSystem() {
    initializeSchedule();
    clearStorage();
    hideResetModal();
    renderSchedule();
    renderWorkerStats();
    alert('×”××©××¨×•×ª ××•×¤×¡×• ×‘×”×¦×œ×—×”!');
  }

  // Clear all data
  function clearAllData() {
    if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×ª×¨×¦×” ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™× ×”×©××•×¨×™× ×•×œ×”×—×–×™×¨ ××ª ×”××¢×¨×›×ª ×œ××¦×‘ ×”×”×ª×—×œ×ª×™? ×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) {
      workers = {
        cooks: [
          { name: '××œ×™×”', restrictions: [] },
          { name: '××œ×™××‘', restrictions: ['onlyMorning', 'onlySunToWed', 'noCooking'] },
          { name: '×™×”×•×“×”', restrictions: ['noCooking', 'saladsOnly'] },
          { name: '××¤×¨×™×', restrictions: [] },
          { name: '×œ×™××•×¨', restrictions: [] },
          { name: '××™×ª×™', restrictions: ['prefersSalads'] },
          { name: '×™×¦×—×§', restrictions: [] },
          { name: '×™×•×¡×£', restrictions: [] }
        ],
        responsible: ['××œ×™', '××•×¨×™××œ', '××¨×™××œ']
      };
      targetShifts = 4;
      document.getElementById('targetShifts').value = targetShifts;

      initializeSchedule();
      clearStorage();

      renderWorkersList();
      renderWorkerStats();
      renderSchedule();

      alert('×›×œ ×”× ×ª×•× ×™× × ××—×§×• ×•×”××¢×¨×›×ª ×—×–×¨×” ×œ××¦×‘ ×”×”×ª×—×œ×ª×™');
    }
  }

  // Export data
  function exportData() {
    try {
      let content = '\ufeff';
      content += '×™×•×,××©××¨×ª,×˜×‘×—×™×,××—×¨××™ ×ª×•×¨× ×™×,××—×¨××™ ×‘×™×©×•×œ×™×,××—×¨××™ ×¡×œ×˜×™×\n';

      days.forEach(day => {
        if (day === '×¡×•×¤×©') {
          const data = schedule[day]['×›×œ ×”×¡×•×¤×©'];
          content += `${day},×›×œ ×”×¡×•×¤×©,"${data.cooks.join(', ')}","${data.responsible.join(', ')}",×œ× ×¨×œ×•×•× ×˜×™,×œ× ×¨×œ×•×•× ×˜×™\n`;
        } else {
          const shiftsForDay = day === '×©×™×©×™' ? ['×‘×•×§×¨'] : ['×‘×•×§×¨', '×¢×¨×‘'];
          shiftsForDay.forEach(shift => {
            const data = schedule[day][shift];
            content += `${day},${shift},"${data.cooks.join(', ')}","${data.responsible.join(', ')}",${data.cookingChef || ''},${data.saladsChef || ''}\n`;
          });
        }
      });

      const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = '××©××¨×•×ª_××˜×‘×—.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      alert('×”×§×•×‘×¥ ×™×•×¦× ×‘×”×¦×œ×—×”!');
    } catch (error) {
      alert('×©×’×™××” ×‘×™×™×¦×•× ×”×§×•×‘×¥: ' + error.message);
    }
  }

  // Modal functions
  function showAddWorkerModal() {
    document.getElementById('addWorkerModal').classList.add('show');
  }

  function hideAddWorkerModal() {
    document.getElementById('addWorkerModal').classList.remove('show');
    document.getElementById('newWorkerName').value = '';
  }

  function showResetModal() {
    document.getElementById('resetModal').classList.add('show');
  }

  function hideResetModal() {
    document.getElementById('resetModal').classList.remove('show');
  }

  function hideSelectWorkerModal() {
    document.getElementById('selectWorkerModal').classList.remove('show');
  }

  function hideRemoveWorkerModal() {
    document.getElementById('removeWorkerModal').classList.remove('show');
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function() {
    const loaded = loadFromStorage();
    if (!loaded) {
      initializeSchedule();
    }

    renderWorkersList();
    renderWorkerStats();
    renderSchedule();

    // Target shifts input
    document.getElementById('targetShifts').addEventListener('change', function() {
      targetShifts = parseInt(this.value) || 4;
      saveToStorage();
      renderWorkerStats();
    });

    // Enter key for new worker
    document.getElementById('newWorkerName').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') addNewWorker();
    });
  });

function renderHistoryTable(weeks) {
  const container = document.getElementById('historyTable');
  if (!weeks || weeks.length === 0) {
    container.innerHTML = '<p style="text-align:center; color: #666;">×œ× ×§×™×™××™× × ×ª×•× ×™× ×§×•×“××™×</p>';
    return;
  }

  const allNames = new Set();
  weeks.forEach(week => {
    const shifts = week.shifts || {};
    Object.values(shifts).forEach(day => {
      Object.values(day).forEach(shift => {
        if (shift && typeof shift === 'object') {
          (shift.cooks || []).forEach(name => allNames.add(name));
          (shift.responsible || []).forEach(name => allNames.add(name));
          if (shift.cookingChef) allNames.add(shift.cookingChef);
          if (shift.saladsChef) allNames.add(shift.saladsChef);
        }
      });
    });
  });

  const names = Array.from(allNames).sort();
  let html = '<table><thead><tr><th>×©×‘×•×¢</th>';
  names.forEach(name => {
    html += `<th>${name}</th>`;
  });
  html += '</tr></thead><tbody>';

  weeks.forEach(week => {
    const shiftData = week.shifts || {};
    const weekId = week.week || '×œ×œ× ××–×”×”';
    const counts = {};
    names.forEach(n => counts[n] = 0);

    Object.values(shiftData).forEach(day => {
      Object.values(day).forEach(shift => {
        if (shift && typeof shift === 'object') {
          (shift.cooks || []).forEach(name => counts[name] += 1);
          (shift.responsible || []).forEach(name => counts[name] += 1);
          if (shift.cookingChef && counts[shift.cookingChef] !== undefined) counts[shift.cookingChef] += 1;
          if (shift.saladsChef && counts[shift.saladsChef] !== undefined) counts[shift.saladsChef] += 1;
        }
      });
    });

    html += `<tr><td>${weekId}</td>`;
    names.forEach(name => {
      html += `<td>${counts[name]}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

</script>
<!-- Firebase SDK with Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ×”×’×“×¨×•×ª ×”×¤×¨×•×™×§×˜ ×©×œ×š ×-Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCaiYonDRZCs78i0T39ndgeIGzyQsUa0m8",
    authDomain: "kitchenshifts-9ad09.firebaseapp.com",
    projectId: "kitchenshifts-9ad09",
    storageBucket: "kitchenshifts-9ad09.firebasestorage.app",
    messagingSenderId: "158717674060",
    appId: "1:158717674060:web:0a2a3af94cd01e3255aae9",
    measurementId: "G-EZKBQYGM6R"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ××—×–×™×¨ ××–×”×” ×©×‘×•×¢ ×›××• "2025-W25"
  function getWeekId(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return `${d.getUTCFullYear()}-W${weekNo.toString().padStart(2, '0')}`;
  }

  // ×©××™×¨×”
  async function saveCurrentWeek(data) {
    const today = new Date();
    const weekId = getWeekId(today);
    await addDoc(collection(db, "weeks"), {
      week: weekId,
      created: today.toISOString(),
      shifts: data
    });
    alert("âœ… ×”×©×‘×•×¢ × ×©××¨ ×œ-Firebase!");
  }

  // ×˜×¢×™× ×”
  async function loadAllWeeks() {
    const q = query(collection(db, "weeks"), orderBy("created", "desc"));
    const snapshot = await getDocs(q);
    const allWeeks = [];
    snapshot.forEach(doc => allWeeks.push(doc.data()));
    console.log("ğŸ“Š ×©×‘×•×¢×•×ª ×§×•×“××™×:", allWeeks);
    return allWeeks;
  }

  // ×–××™× ×•×ª ×œ×›×œ ×”×“×£
  window.saveToFirebase = () => saveCurrentWeek(schedule);
  window.loadHistory = () => loadAllWeeks().then(weeks => {
    // ×ª×•×›×œ ×œ×‘× ×•×ª ×˜×‘×œ×” ××• ×’×¨×£ ×›××Ÿ
    console.log("×¡×˜×˜×™×¡×˜×™×§×”:", weeks);
  });

function renderHistoryTable(weeks) {
  const container = document.getElementById('historyTable');
  if (!weeks || weeks.length === 0) {
    container.innerHTML = '<p style="text-align:center; color: #666;">×œ× ×§×™×™××™× × ×ª×•× ×™× ×§×•×“××™×</p>';
    return;
  }

  const allNames = new Set();
  weeks.forEach(week => {
    const shifts = week.shifts || {};
    Object.values(shifts).forEach(day => {
      Object.values(day).forEach(shift => {
        if (shift && typeof shift === 'object') {
          (shift.cooks || []).forEach(name => allNames.add(name));
          (shift.responsible || []).forEach(name => allNames.add(name));
          if (shift.cookingChef) allNames.add(shift.cookingChef);
          if (shift.saladsChef) allNames.add(shift.saladsChef);
        }
      });
    });
  });

  const names = Array.from(allNames).sort();
  let html = '<table><thead><tr><th>×©×‘×•×¢</th>';
  names.forEach(name => {
    html += `<th>${name}</th>`;
  });
  html += '</tr></thead><tbody>';

  weeks.forEach(week => {
    const shiftData = week.shifts || {};
    const weekId = week.week || '×œ×œ× ××–×”×”';
    const counts = {};
    names.forEach(n => counts[n] = 0);

    Object.values(shiftData).forEach(day => {
      Object.values(day).forEach(shift => {
        if (shift && typeof shift === 'object') {
          (shift.cooks || []).forEach(name => counts[name] += 1);
          (shift.responsible || []).forEach(name => counts[name] += 1);
          if (shift.cookingChef && counts[shift.cookingChef] !== undefined) counts[shift.cookingChef] += 1;
          if (shift.saladsChef && counts[shift.saladsChef] !== undefined) counts[shift.saladsChef] += 1;
        }
      });
    });

    html += `<tr><td>${weekId}</td>`;
    names.forEach(name => {
      html += `<td>${counts[name]}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

</script>
</body>
</html>
<!-- Weekly History -->
<div class="card">
  <div class="section">
    <div class="section-title">ğŸ“š ×”×™×¡×˜×•×¨×™×™×ª ×©×‘×•×¢×•×ª</div>
    <div id="historyTable" class="table-container"></div>
  </div>
</div>
